<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Power Booster Dashboard</title>
    
    <!-- Firebase SDK v12 (Modular) with Database -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA_J46aRkLCQoLXoTKAHzbiJz0miLy69Co",
            authDomain: "solar-power-booster.firebaseapp.com",
            databaseURL: "https://solar-power-booster-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "solar-power-booster",
            storageBucket: "solar-power-booster.firebasestorage.app",
            messagingSenderId: "303832656310",
            appId: "1:303832656310:web:f53d1f874057e6971e3917"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Database secret for authentication (from your ESP32 code)
        const DATABASE_SECRET = "4IQoVsXfyOQen7zBb6Vwj5U8tLPsBvTsTLxP7k0Y";
        
        // Create database reference with authentication
        const dataRef = ref(database, 'solar_system');
        
        // URL with auth parameter (legacy way - still works for reading)
        const databaseUrl = `https://solar-power-booster-default-rtdb.asia-southeast1.firebasedatabase.app/solar_system.json?auth=${DATABASE_SECRET}`;
        
        // Store Firebase for global access
        window.firebaseApp = {
            db: database,
            dataRef: dataRef,
            onValue: onValue,
            databaseUrl: databaseUrl,
            secret: DATABASE_SECRET
        };

        console.log("Firebase initialized with database secret");
        
        // Test connection immediately
        testFirebaseConnection();
        
        async function testFirebaseConnection() {
            try {
                console.log("Testing Firebase connection...");
                console.log("URL:", databaseUrl);
                
                // Method 1: Try REST API with auth
                const response = await fetch(databaseUrl);
                const data = await response.json();
                console.log("REST API test result:", data);
                
                if (data) {
                    console.log("‚úÖ Firebase connection successful via REST API");
                    document.getElementById('statusText').textContent = "Connected via REST API";
                    document.getElementById('statusText').style.color = "green";
                    
                    // Process initial data
                    if (window.processFirebaseData) {
                        window.processFirebaseData(data);
                    }
                }
            } catch (error) {
                console.error("‚ùå Firebase connection failed:", error);
                document.getElementById('statusText').textContent = "Connection failed: " + error.message;
                document.getElementById('statusText').style.color = "red";
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
            display: inline-block;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .card h3 {
            margin-top: 0;
            color: #555;
        }
        
        .value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
        }
        
        .unit {
            color: #666;
            font-size: 1rem;
        }
        
        .chart-container {
            grid-column: 1 / -1;
            height: 400px;
            margin-top: 20px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .data-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .data-item .label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .data-item .value {
            font-size: 1.8rem;
            color: #333;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #666;
        }
        
        .connection-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚òÄÔ∏è Solar Power Booster Dashboard</h1>
            <p>Real-time monitoring system with Firebase authentication</p>
            <div class="status">
                <span>Firebase Status: </span>
                <span id="statusText" class="connection-status">Connecting...</span>
            </div>
        </header>
        
        <main class="dashboard">
            <!-- Voltage Card -->
            <div class="card">
                <h3>‚ö° Output Voltage</h3>
                <div class="value" id="voltageValue">--.-- <span class="unit">V</span></div>
                <div class="label">Target: 12.0V | Boost Controlled</div>
                <div style="margin-top: 15px; height: 10px; background: #eee; border-radius: 5px;">
                    <div id="voltageBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4CAF50, #2196F3); border-radius: 5px;"></div>
                </div>
            </div>
            
            <!-- Temperature Card -->
            <div class="card">
                <h3>üå°Ô∏è System Temperature</h3>
                <div class="value" id="tempValue">--.- <span class="unit">¬∞C</span></div>
                <div class="label">Auto-cooling with PWM Fan</div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 0.8rem; color: #666;">Cool</span>
                        <span style="font-size: 0.8rem; color: #666;">Hot</span>
                    </div>
                    <div style="height: 10px; background: #eee; border-radius: 5px;">
                        <div id="tempBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #2196F3, #f44336); border-radius: 5px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Fan Speed Card -->
            <div class="card">
                <h3>üåÄ Cooling Fan</h3>
                <div class="value" id="fanValue">-- <span class="unit">%</span></div>
                <div class="label">PWM Speed Control</div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 0.8rem; color: #666;">Off</span>
                        <span style="font-size: 0.8rem; color: #666;">Max</span>
                    </div>
                    <div style="height: 10px; background: #eee; border-radius: 5px;">
                        <div id="fanBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4CAF50, #FF9800); border-radius: 5px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Servo Angle Card -->
            <div class="card">
                <h3>üîÑ Servo Position</h3>
                <div class="value" id="servoValue">--- <span class="unit">¬∞</span></div>
                <div class="label">Range: 30¬∞ to 150¬∞</div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 0.8rem; color: #666;">Left (30¬∞)</span>
                        <span style="font-size: 0.8rem; color: #666;">Center (90¬∞)</span>
                        <span style="font-size: 0.8rem; color: #666;">Right (150¬∞)</span>
                    </div>
                    <div style="height: 10px; background: #eee; border-radius: 5px;">
                        <div id="servoBar" style="height: 100%; width: 50%; background: linear-gradient(90deg, #9C27B0, #E91E63); border-radius: 5px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Data Grid -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üìä System Parameters</h3>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="label">Output Voltage</div>
                        <div class="value" id="gridVoltage">--.-- V</div>
                    </div>
                    <div class="data-item">
                        <div class="label">Temperature</div>
                        <div class="value" id="gridTemp">--.- ¬∞C</div>
                    </div>
                    <div class="data-item">
                        <div class="label">Fan Speed</div>
                        <div class="value" id="gridFan">-- %</div>
                    </div>
                    <div class="data-item">
                        <div class="label">Servo Angle</div>
                        <div class="value" id="gridServo">--- ¬∞</div>
                    </div>
                    <div class="data-item">
                        <div class="label">Boost Duty</div>
                        <div class="value" id="gridBoost">---</div>
                    </div>
                    <div class="data-item">
                        <div class="label">Timestamp</div>
                        <div class="value" id="gridTime">--:--:--</div>
                    </div>
                </div>
            </div>
            
            <!-- Chart Container -->
            <div class="card chart-container">
                <h3>üìà 24-Hour Historical Data</h3>
                <canvas id="historyChart"></canvas>
            </div>
        </main>
        
        <footer>
            <p>Solar Power Booster System ‚Ä¢ ESP32 + Firebase ‚Ä¢ Database Secret Authentication</p>
            <p>Last update: <span id="lastUpdateTime">Never</span> | Data points: <span id="dataCount">0</span></p>
        </footer>
    </div>

    <script>
        // Global variables for data storage
        let historyData = {
            timestamps: [],
            voltages: [],
            temperatures: [],
            fans: [],
            servos: []
        };
        
        let chart = null;
        let lastData = null;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            startDataPolling();
        });
        
        // Initialize the chart
        function initChart() {
            const ctx = document.getElementById('historyChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Voltage (V)',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Temperature (¬∞C)',
                            data: [],
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Start polling for data
        function startDataPolling() {
            // Poll every 2 seconds
            setInterval(fetchFirebaseData, 2000);
            
            // Initial fetch
            fetchFirebaseData();
        }
        
        // Fetch data from Firebase using REST API
        async function fetchFirebaseData() {
            try {
                if (!window.firebaseApp || !window.firebaseApp.databaseUrl) {
                    console.error("Firebase not initialized");
                    return;
                }
                
                const response = await fetch(window.firebaseApp.databaseUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data) {
                    processFirebaseData(data);
                } else {
                    console.warn("No data received from Firebase");
                }
                
            } catch (error) {
                console.error("Error fetching Firebase data:", error);
                document.getElementById('statusText').textContent = "Error: " + error.message;
                document.getElementById('statusText').style.color = "red";
            }
        }
        
        // Process Firebase data
        window.processFirebaseData = function(data) {
            const now = new Date();
            
            // Update UI elements
            if (data.vout !== undefined) {
                updateValue('voltage', data.vout);
                document.getElementById('gridVoltage').textContent = data.vout.toFixed(2) + " V";
                updateProgressBar('voltageBar', (data.vout / 20) * 100);
            }
            
            if (data.temperature !== undefined) {
                updateValue('temp', data.temperature);
                document.getElementById('gridTemp').textContent = data.temperature.toFixed(1) + " ¬∞C";
                updateProgressBar('tempBar', (data.temperature / 80) * 100);
            }
            
            if (data.fan_percent !== undefined) {
                updateValue('fan', data.fan_percent);
                document.getElementById('gridFan').textContent = data.fan_percent + " %";
                updateProgressBar('fanBar', data.fan_percent);
            }
            
            if (data.servo_angle !== undefined) {
                updateValue('servo', data.servo_angle);
                document.getElementById('gridServo').textContent = data.servo_angle + " ¬∞";
                const servoPercent = ((data.servo_angle - 30) / 120) * 100;
                updateProgressBar('servoBar', servoPercent);
            }
            
            if (data.boost_duty !== undefined) {
                document.getElementById('gridBoost').textContent = data.boost_duty;
            }
            
            if (data.timestamp !== undefined) {
                const date = new Date(data.timestamp * 1000);
                document.getElementById('gridTime').textContent = date.toLocaleTimeString();
            }
            
            // Store in history for chart
            historyData.timestamps.push(now);
            historyData.voltages.push(data.vout || 0);
            historyData.temperatures.push(data.temperature || 0);
            historyData.fans.push(data.fan_percent || 0);
            historyData.servos.push(data.servo_angle || 90);
            
            // Keep only last 1000 points for performance
            const maxPoints = 1000;
            if (historyData.timestamps.length > maxPoints) {
                historyData.timestamps.shift();
                historyData.voltages.shift();
                historyData.temperatures.shift();
                historyData.fans.shift();
                historyData.servos.shift();
            }
            
            // Update chart
            updateChart();
            
            // Update status
            document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString();
            document.getElementById('dataCount').textContent = historyData.timestamps.length;
            document.getElementById('statusText').textContent = "Connected - Data Updated";
            document.getElementById('statusText').style.color = "green";
        }
        
        // Update value display with animation
        function updateValue(type, value) {
            const element = document.getElementById(type + 'Value');
            if (!element) return;
            
            const oldText = element.textContent;
            let newText = '';
            
            switch(type) {
                case 'voltage':
                    newText = value.toFixed(2) + " V";
                    break;
                case 'temp':
                    newText = value.toFixed(1) + " ¬∞C";
                    break;
                case 'fan':
                case 'servo':
                    newText = Math.round(value) + (type === 'fan' ? ' %' : '¬∞');
                    break;
            }
            
            if (oldText !== newText) {
                element.style.transform = 'scale(1.1)';
                element.style.color = '#ff4081';
                element.textContent = newText;
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                    element.style.color = '#667eea';
                }, 300);
            }
        }
        
        // Update progress bar
        function updateProgressBar(barId, percent) {
            const bar = document.getElementById(barId);
            if (bar) {
                bar.style.width = Math.min(percent, 100) + '%';
            }
        }
        
        // Update the chart
        function updateChart() {
            if (!chart || historyData.timestamps.length === 0) return;
            
            // Use only recent points for better performance
            const recentPoints = 100;
            const startIdx = Math.max(0, historyData.timestamps.length - recentPoints);
            
            chart.data.labels = historyData.timestamps.slice(startIdx);
            chart.data.datasets[0].data = historyData.voltages.slice(startIdx);
            chart.data.datasets[1].data = historyData.temperatures.slice(startIdx);
            
            chart.update('none');
        }
        
        // Manual refresh button (optional)
        function refreshData() {
            document.getElementById('statusText').textContent = "Refreshing...";
            document.getElementById('statusText').style.color = "orange";
            fetchFirebaseData();
        }
        
        // Make refresh function available
        window.refreshData = refreshData;
    </script>
</body>
</html>
